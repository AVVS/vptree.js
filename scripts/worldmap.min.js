"use strict";function Matrix(tableauDeCoeffs){this.coeff=[];this.identity=function(){this.coeff=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]};if(tableauDeCoeffs)this.coeff=tableauDeCoeffs;else this.identity();this.apply=function(x,y,z,v){var nx=this.coeff[0]*x+this.coeff[1]*y+this.coeff[2]*z+this.coeff[3];var ny=this.coeff[4]*x+this.coeff[5]*y+this.coeff[6]*z+this.coeff[7];var nz=this.coeff[8]*x+this.coeff[9]*y+this.coeff[10]*z+this.coeff[11];var nw=this.coeff[12]*x+this.coeff[13]*y+this.coeff[14]*z+this.coeff[15];if(!v)return[nx/nw,ny/nw,nz/nw];v[0]=nx/nw;v[1]=ny/nw;return v};this.clone=function(){return new Matrix(this.coeff)};this.multiply=function(coeffs){var newMatrix=[];for(var row=0;row<4;row++)for(var col=0;col<4;col++){newMatrix[row*4+col]=this.coeff[row*4+0]*coeffs[0*4+col]+this.coeff[row*4+1]*coeffs[1*4+col]+this.coeff[row*4+2]*coeffs[2*4+col]+this.coeff[row*4+3]*coeffs[3*4+col]}this.coeff=newMatrix;return this};this.transposeMultiply=function(coeffs){var newMatrix=[],m1,m2;for(var row=0;row<4;row++){m1=row*4;for(var col=0;col<4;col++){m2=col*4;newMatrix[row*4+col]=this.coeff[m1+0]*coeffs[m2+0]+this.coeff[m1+1]*coeffs[m2+1]+this.coeff[m1+2]*coeffs[m2+2]+this.coeff[m1+3]*coeffs[m2+3]}}this.coeff=newMatrix;return this};this.translate=function(tx,ty,tz){var col=[this.coeff[0]*tx+this.coeff[1]*ty+this.coeff[2]*tz+this.coeff[3],this.coeff[4]*tx+this.coeff[5]*ty+this.coeff[6]*tz+this.coeff[7],this.coeff[8]*tx+this.coeff[9]*ty+this.coeff[10]*tz+this.coeff[11],this.coeff[12]*tx+this.coeff[13]*ty+this.coeff[14]*tz+this.coeff[15]];this.coeff[3]=col[0];this.coeff[7]=col[1];this.coeff[11]=col[2];this.coeff[15]=col[3];return this};this.rotatex=function(a){var c=Math.cos(a);var s=Math.sin(a);this.multiply([1,0,0,0,0,c,-s,0,0,s,c,0,0,0,0,1]);return this};this.rotatey=function(a){var c=Math.cos(a);var s=Math.sin(a);this.multiply([c,0,s,0,0,1,0,0,-s,0,c,0,0,0,0,1]);return this};this.rotatez=function(a){var c=Math.cos(a);var s=Math.sin(a);this.multiply([c,-s,0,0,s,c,0,0,0,0,1,0,0,0,0,1]);return this};this.scale=function(sx,sy,sz){this.multiply([sx,0,0,0,0,sy,0,0,0,0,sz,0,0,0,0,1]);return this};this.perspective=function(fovy,aspect,near,far){var matrix=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];var t=Math.tan(fovy*.5)*near;var b=-t;var r=aspect*t;var l=-r;matrix[0]=near/r;matrix[5]=near/t;matrix[10]=(far+near)/(near-far);matrix[11]=2*far*near/(near-far);matrix[14]=-1;this.coeff=matrix;return this};this.perspectiveInverse=function(fovy,aspect,near,far){var matrix=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];var t=Math.tan(fovy*.5)*near;var b=-t;var r=aspect*t;var l=-r;matrix[0]=r/near;matrix[5]=t/near;matrix[11]=-1;matrix[14]=(near-far)/(2*far*near);matrix[15]=(near+far)/(2*far*near);this.coeff=matrix;return this};this.lookAt=function(eyex,eyey,eyez,centerx,centery,centerz,upx,upy,upz){var f=normalize([centerx-eyex,centery-eyey,centerz-eyez]);var up=normalize([upx,upy,upz]);var s=crossProduct(f,up);var u=crossProduct(s,f);this.coeff=[s[0],s[1],s[2],0,u[0],u[1],u[2],0,-f[0],-f[1],-f[2],0,0,0,0,1];this.translate(-eyex,-eyey,-eyez)};this.lookAt2=function(centerx,centery,centerz,θx,θy,δ){this.coeff=Matrix.translation(0,0,-δ);this.transposeMultiply(Matrix.rotationxy(-θy,θx));this.translate(-centerx,-centery,-centerz)};this.lookAt2Inverse=function(centerx,centery,centerz,θx,θy,δ){this.coeff=Matrix.translation(centerx,centery,centerz);this.multiply(Matrix.rotationxy(-θy,θx));this.translate(0,0,δ)};function normalize(vector){var norm=Math.sqrt(vector[0]*vector[0]+vector[1]*vector[1]+vector[2]*vector[2]);var newVector=[];newVector[0]=vector[0]/norm;newVector[1]=vector[1]/norm;newVector[2]=vector[2]/norm;return newVector}function crossProduct(u,v){var w=[];w[0]=u[1]*v[2]-u[2]*v[1];w[1]=u[2]*v[0]-u[0]*v[2];w[2]=u[0]*v[1]-u[1]*v[0];return w}}Matrix.translation=function(tx,ty,tz){return[1,0,0,tx,0,1,0,ty,0,0,1,tz,0,0,0,1]};Matrix.rotationxy=function(θ,φ){var cθ=Math.cos(θ);var sθ=Math.sin(θ);var cφ=Math.cos(φ);var sφ=Math.sin(φ);return[cφ,sθ*sφ,cθ*sφ,0,0,cθ,-sθ,0,-sφ,sθ*cφ,cθ*cφ,0,0,0,0,1]};"use strict";function View3D(){var modelview=new Matrix;var projection=new Matrix;var modelviewInv=new Matrix;var projectionInv=new Matrix;var vertices=[];this.lookAt=function(eyex,eyey,eyez,centerx,centery,centerz,upx,upy,upz){modelview.lookAt(eyex,eyey,eyez,centerx,centery,centerz,upx,upy,upz)};this.lookAt2=function(centerx,centery,centerz,θx,θy,δ){modelview.lookAt2(centerx,centery,centerz,θx,θy,δ);modelviewInv.lookAt2Inverse(centerx,centery,centerz,θx,θy,δ)};this.checkMatrices=function(){console.log(projection.clone().multiply(projectionInv.coeff).coeff);console.log(modelview.clone().multiply(modelviewInv.coeff).coeff)};var current={centerx:0,centery:0,centerz:0,"θx":0,"θy":0,"δ":0};var backupθx,backupθy;this.init=function(centerx,centery,centerz,θx,θy,δ){current.centerx=centerx;current.centery=centery;current.centerz=centerz;current.θx=θx;current.θy=θy;current.δ=δ;this.lookAt2(centerx,centery,centerz,θx,θy,δ)};this.rotate=function(θx,θy){current.θx+=θx;current.θy+=θy;this.lookAt2(current.centerx,current.centery,current.centerz,current.θx,current.θy,current.δ)};this.backup=function(){backupθx=current.θx;backupθy=current.θy};this.restore=function(){current.θx=backupθx;current.θy=backupθy};this.perspective=function(fovy,aspect,near,far){projection.perspective(fovy,aspect,near,far);projectionInv.perspectiveInverse(fovy,aspect,near,far)};this.projectVertices=function(X,Y,Z,x,y,z){var m=projection.clone();m.multiply(modelview.coeff);var coeff=m.coeff,c0=coeff[0],c1=coeff[1],c2=coeff[2],c3=coeff[3],c4=coeff[4],c5=coeff[5],c6=coeff[6],c7=coeff[7],c8=coeff[8],c9=coeff[9],c10=coeff[10],c11=coeff[11],c12=coeff[12],c13=coeff[13],c14=coeff[14],c15=coeff[15];var n=X.length,nx,ny,nz,nw,vx,vy,vz;for(var i=0;i<n;i++){vx=X[i];vy=Y[i];vz=Z[i];nx=c0*vx+c1*vy+c2*vz+c3;ny=c4*vx+c5*vy+c6*vz+c7;nz=c8*vx+c9*vy+c10*vz+c11;nw=c12*vx+c13*vy+c14*vz+c15;x[i]=nx/nw;y[i]=ny/nw;z[i]=nz/nw}};this.getPMMatrix=function(){return projection.clone().multiply(modelview.coeff).coeff};this.projectOne=function(X,Y,Z){var m=projection.clone();m.multiply(modelview.coeff);return m.apply(X,Y,Z)};this.unprojectOne=function(x,y,z){var m=modelviewInv.clone();m.multiply(projectionInv.coeff);return m.apply(x,y,z)};this.getmv=function(){return modelview.coeff};this.getproj=function(){return projection.coeff}}"use strict";$(function(){var cityNames=cities.names.split(",");cities.names=null;var totalCities=cityNames.length;var coordList=cities.coords,cityCoords=[];for(var i=0,j=0;i<totalCities;i++){cityCoords[i]=[coordList[j++]/1e3,coordList[j++]/1e3]}cities.coords=null;function dist(a,b){var meters=Geo.distVincenty(a[0],a[1],b[0],b[1]);return Math.round(meters/100)/10}var vptree=VPTreeFactory.load(cityCoords,dist,treedata);var canvas=$("#map").get(0);var context=canvas.getContext("2d"),cw=canvas.width,ch=canvas.height;var X=new Float32Array(totalCities),Y=new Float32Array(totalCities),Z=new Float32Array(totalCities),x=new Float32Array(totalCities),y=new Float32Array(totalCities),z=new Float32Array(totalCities);function generateCities(X,Y,Z){var n=totalCities,toRad=Math.PI/180;for(var i=0;i<n;i++){var coord=cityCoords[i],latitude=coord[0]*toRad,longitude=coord[1]*toRad,r=Math.cos(latitude);if(r<0)r=-r;X[i]=r*Math.sin(longitude),Y[i]=Math.sin(latitude),Z[i]=r*Math.cos(longitude)}}var OΩ=6.6,ZClip=1/OΩ,rmax=Math.sqrt(1-1/(OΩ*OΩ))/ZClip;var view=new View3D;var fov=2*Math.asin(1/OΩ);view.perspective(fov,cw/ch,1,40);view.init(0,0,0,0,0,OΩ);var zClip=view.projectOne(0,0,ZClip)[2];var worker;function plot(x,y,z){var centerx=cw/2,centery=ch/2,r=.4975*Math.min(cw,ch),tau=2*Math.PI;var imageData=context.getImageData(0,0,cw,ch).data;var output=context.createImageData(cw,ch),outputData=output.data;var n=totalCities,w=cw,_zClip=zClip,_x,_y,index;var xmin=Infinity,ymax=0;for(var i=0;i<n;i++){_x=centerx+r*x[i]|0;_y=centery-r*y[i]|0;if(_x<xmin)xmin=_x;if(_y>ymax)ymax=_y;index=_x+w*_y<<2;if(z[i]>_zClip){outputData[index++]=170;outputData[index++]=170;outputData[index++]=170;outputData[index++]=255}}if(xmin>centerx||ymax<centery){console.log("skip frame");return}for(var i=0;i<n;i++){_x=centerx+r*x[i]|0;_y=centery-r*y[i]|0;index=_x+w*_y<<2;if(z[i]<_zClip){outputData[index++]=40;outputData[index++]=40;outputData[index++]=40;outputData[index++]=255}}context.putImageData(output,0,0)}function rayIntersect(coords0,coords1){var X0=coords0[0],Y0=coords0[1],Z0=coords0[2],dX=coords1[0]-coords0[0],dY=coords1[1]-coords0[1],dZ=coords1[2]-coords0[2],a=dX*dX+dY*dY+dZ*dZ,b=2*X0*dX+2*Y0*dY+2*Z0*dZ,c=X0*X0+Y0*Y0+Z0*Z0-1,Δ=b*b-4*a*c;if(Δ>=0){var t=(-b-Math.sqrt(Δ))/(2*a),X=dX*t+X0,Y=dY*t+Y0,Z=dZ*t+Z0;var π=Math.PI,toDeg=180/π;var latitude=Math.asin(Y),r=Math.sqrt(X*X+Z*Z);X/=r;Z/=r;var longitude;if(.5<X&&X<.5){longitude=Math.asin(X);if(Z<0)longitude=π-longitude;if(longitude>π)longitude-=2*π}else{longitude=Math.acos(Z);if(X<0)longitude=-longitude}return[latitude*toDeg,longitude*toDeg]}}function searchNearest(mx,my,query){plot(x,y,z);if(!query){$("#resultmeta").css("visibility","hidden");return}$("#resultmeta").css("visibility","visible");var searchResults=vptree.search(query,3);document.getElementById("qlat").innerHTML=Geo.toLat(query[0]);document.getElementById("qlon").innerHTML=Geo.toLon(query[1]);document.getElementById("comparisons").innerHTML=vptree.comparisons;for(var i=0;i<3;i++){var found=searchResults[i],cityId=found.i,cityCoord=cityCoords[cityId],$cells=$resultLines.eq(i).children();$cells.eq(1).text(found.d);$cells.eq(2).text(cityNames[cityId]);$cells.eq(3).text(cities.countries.substr(cityId*2,2));$cells.eq(4).text(Geo.toLat(cityCoords[cityId][0]));$cells.eq(5).text(Geo.toLon(cityCoords[cityId][1]));context.strokeStyle="#0000ff";context.beginPath();context.moveTo(mx,my);context.lineTo((x[cityId]+1)*cw/2,(1-y[cityId])*ch/2);context.stroke()}}function localAction(mouseX,mouseY){var x=2*mouseX/cw-1,y=1-2*mouseY/ch,coords0=view.unprojectOne(x,y,-1),coords1=view.unprojectOne(x,y,1),earthCoords=rayIntersect(coords0,coords1);searchNearest(mouseX,mouseY,earthCoords)}function initWorker(){if(window.Worker){worker=new Worker("scripts/vertexProjector.js");worker.onmessage=workerReceive;try{worker.postMessage(X.buffer,[X.buffer]);worker.postMessage(Y.buffer,[Y.buffer]);worker.postMessage(Z.buffer,[Z.buffer]);worker.useTransferrable=true}catch(e){worker.postMessage("Do not use transferrable");worker.postMessage(X.buffer);worker.postMessage(Y.buffer);worker.postMessage(Z.buffer);worker.useTransferrable=false}}}function workerReceive(e){if(typeof e.data==="string"){console.log("worker says: "+e.data);return}switch(worker.state){case 0:x=new Float32Array(e.data);worker.state=1;break;case 1:y=new Float32Array(e.data);worker.state=2;break;case 2:z=new Float32Array(e.data);if(x.length&&y.length&&z.length){view.projectVertices(X,Y,Z,x,y,z);plot(x,y,z)}worker.state=0;break}}function updateDisplay(){if(!x.length&&!y.length&&!z.length)return;if(worker){worker.state=0;worker.postMessage(view.getPMMatrix());if(worker.useTransferrable){try{worker.postMessage(x.buffer,[x.buffer]);worker.postMessage(y.buffer,[y.buffer]);worker.postMessage(z.buffer,[z.buffer])}catch(e){}}else{worker.postMessage(x.buffer);worker.postMessage(y.buffer);worker.postMessage(z.buffer)}}else{view.projectVertices(X,Y,Z,x,y,z);plot(X,Y,Z,x,y,z)}}generateCities(X,Y,Z);initWorker();updateDisplay();var $resultLines=$("#resultlist>tbody>tr");var dragging=false,startX,startY;$("#map").mousedown(function(event){dragging=true;startX=event.pageX;startY=event.pageY;view.backup();var pos=$(this).offset();localAction(startX-pos.left,startY-pos.top)}).mousemove(function(event){if(dragging)return;var pos=$(this).offset();localAction(event.pageX-pos.left,event.pageY-pos.top)});$(document).mousemove(function(event){if(!dragging)return;var dx=event.pageX-startX,dy=event.pageY-startY;view.restore();view.rotate(-.5*dx*Math.PI/180,.5*dy*Math.PI/180);updateDisplay()}).mouseup(function(){dragging=false})});
